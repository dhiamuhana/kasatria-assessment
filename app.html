<!DOCTYPE html>
<html>
    <head>
        <title>Kasatria Assignment - 3D Data Visualization</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            html, body {
                height: 100%;
            }
            body {
                background-color: #000000;
                margin: 0;
                font-family: Helvetica, sans-serif;;
                overflow: hidden;
            }
            a {
                color: #ffffff;
            }
            #info {
                position: absolute;
                top: 10px;
                width: 100%;
                color: #ffffff;
                padding: 5px;
                font-family: Monospace;
                font-size: 13px;
                font-weight: bold;
                text-align: center;
                z-index: 1;
            }
            #menu {
                position: absolute;
                bottom: 20px;
                width: 100%;
                text-align: center;
            }
            /* legend visualisation */
            #legend {
                position: absolute;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                width: 300px;
                text-align: center;
                z-index: 100;
                pointer-events: none;
            }
            #legend .bar {
                height: 12px;
                width: 100%;
                background: linear-gradient(90deg, rgba(200,50,50,0.8) 0%, rgba(255,165,0,0.8) 50%, rgba(0,128,0,0.8) 100%);
                border-radius: 6px;
                border: 1px solid rgba(127,255,255,0.25);
            }
            #legend .labels {
                display: flex;
                justify-content: space-between;
                color: rgba(127,255,255,0.75);
                font-size: 11px;
                margin-top: 5px;
                font-weight: bold;
            }
            
            /* CARD STYLING */
            .element {
                width: 120px;
                height: 180px;
                box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
                border: 1px solid rgba(127,255,255,0.25);
                text-align: center;
                cursor: default;
                position: relative; 
                box-sizing: border-box;
            }

            .element:hover {
                box-shadow: 0px 0px 12px rgba(0,255,255,0.75);
                border: 1px solid rgba(127,255,255,0.75);
            }

            .element img {
                margin-top: 25px; 
                margin-bottom: 5px; 
            }

            .element .name-label {
                font-size: 12px;
                font-weight: bold;
                color: rgba(255,255,255,0.9);
                line-height: 1.2;
                word-wrap: break-word; 
            }

            .element .details {
                font-size: 12px;
                color: rgba(127,255,255,0.75);
                position: absolute;
                bottom: 10px;
                width: 100%;
                left: 0;
            }

            button {
                color: rgba(127,255,255,0.75);
                background: transparent;
                outline: 1px solid rgba(127,255,255,0.75);
                border: 0px;
                padding: 5px 10px;
                cursor: pointer;
            }
            button:hover {
                background-color: rgba(0,255,255,0.5);
            }
            button:active {
                color: #000000;
                background-color: rgba(0,255,255,0.75);
            }
        </style>
    </head>
    <body>

        <div id="info">Kasatria Assessment - Dhia</div>
        <div id="container"></div>
        
        <div id="legend">
            <div class="bar"></div>
            <div class="labels">
                <span>LOW (&lt;100k)</span>
                <span>HIGH (&gt;200k)</span>
            </div>
        </div>

        <div id="menu">
            <button id="table">TABLE</button>
            <button id="sphere">SPHERE</button>
            <button id="helix">HELIX</button>
            <button id="grid">GRID</button>
            <button id="reset">RESET</button> </div>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
                }
            }
        </script>

        <script type="module">

            import * as THREE from 'three';
            import TWEEN from 'three/addons/libs/tween.module.js';
            import { TrackballControls } from 'three/addons/controls/TrackballControls.js';
            import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

            // variables
            let table = [];
            let camera, scene, renderer;
            let controls;
            const objects = [];
            const targets = { table: [], sphere: [], helix: [], grid: [] };

            // data connection
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTe4Y7a8l0T7Ru36XFYpkzsj9IYJcf_sfVJvnxP-22hObfhpT9wLZw4YZgO4L7n3fTqmhVUxUbBJaKW/pub?output=csv';

            // Fetch Data
            function loadData() {
                fetch(sheetUrl)
                    .then(response => response.text())
                    .then(csvText => {
                        parseCSV(csvText);
                        init();     // Initialize 3D world
                        animate();  // Start animation loop
                    })
                    .catch(error => {
                        console.error('Error loading Sheet:', error);
                        alert("Could not load data. Check console for details.");
                    });
            }

            // Parse CSV 
            function parseCSV(text) {
                const rows = text.split('\n');
                for (let i = 1; i < rows.length; i++) {
                    // This regex handles commas inside quotes (e.g. "$250,000")
                    const parts = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    if (parts.length < 6) continue; // Safety check

                    // mapping collumns
                    const name = parts[0].trim();       
                    const image = parts[1].trim();      
                    const age = parts[2].trim();        
                    const country = parts[3].trim();    
                    const interest = parts[4].trim();   
                    
                    // Net Worth is mainly for Color logic
                    let netWorth = parts[5].trim().replace(/^"|"$/g, ''); 

                    // Layout Math (20x10)
                    const col = (i % 20) + 1; 
                    const rowNum = Math.floor(i / 20) + 1;

                    table.push({ 
                        name: name, 
                        image: image,    
                        age: age,
                        country: country,
                        interest: interest,
                        netWorth: netWorth, 
                        col: col, 
                        row: rowNum 
                    });
                }
            }

            // main initialization
            function init() {

                camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
                camera.position.z = 3000;
                scene = new THREE.Scene();

                // Loop through Data
                for ( let i = 0; i < table.length; i ++ ) {

                    const item = table[i];
                    const element = document.createElement( 'div' );
                    element.className = 'element';

                    // net worth logic & colour grading
                    const valueStr = item.netWorth.replace(/[$,"]/g, ''); 
                    const worthValue = parseFloat(valueStr); 
                    
                    if (worthValue > 200000) {
                        element.style.backgroundColor = 'rgba(0,128,0,0.8)'; // Green
                    } else if (worthValue > 100000) {
                        element.style.backgroundColor = 'rgba(255,165,0,0.8)'; // Orange
                    } else {
                        element.style.backgroundColor = 'rgba(200,50,50,0.8)'; // Red
                    }

                    // country (top left)
                    const countryDiv = document.createElement('div');
                    countryDiv.textContent = item.country;
                    countryDiv.style.position = 'absolute';
                    countryDiv.style.top = '10px';
                    countryDiv.style.left = '10px';
                    countryDiv.style.fontSize = '11px';
                    countryDiv.style.fontWeight = 'bold';
                    countryDiv.style.color = 'rgba(127,255,255,0.75)';
                    element.appendChild(countryDiv);

                    // age (top right)
                    const ageDiv = document.createElement('div');
                    ageDiv.textContent = item.age;
                    ageDiv.style.position = 'absolute';
                    ageDiv.style.top = '10px';
                    ageDiv.style.right = '10px';
                    ageDiv.style.fontSize = '11px';
                    ageDiv.style.fontWeight = 'bold';
                    ageDiv.style.color = 'rgba(127,255,255,0.75)';
                    element.appendChild(ageDiv);

                    // image 
                    const img = document.createElement('img');
                    img.src = item.image; 
                    img.style.width = '85px';     // Smaller to fit
                    img.style.height = '85px';
                    img.style.objectFit = 'cover';
                    // Error handler - if the picture tak dapat call
                    img.onerror = function() { 
                        this.src = 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png'; 
                    };
                    element.appendChild(img);

                    // name 
                    const name = document.createElement( 'div' );
                    name.className = 'name-label'; 
                    name.textContent = item.name;
                    element.appendChild( name );

                    // interest (letak kat bottom)
                    const details = document.createElement( 'div' );
                    details.className = 'details';
                    details.innerHTML = item.interest; // Shows Interest (e.g. "Cooking")
                    element.appendChild( details );

                    // Create CSS3D Object
                    const object = new CSS3DObject( element );
                    object.position.x = Math.random() * 4000 - 2000;
                    object.position.y = Math.random() * 4000 - 2000;
                    object.position.z = Math.random() * 4000 - 2000;
                    scene.add( object );
                    objects.push( object );

                    // layout position
                    const objectTable = new THREE.Object3D();
                    objectTable.position.x = ( item.col * 140 ) - 1330;
                    objectTable.position.y = - ( item.row * 180 ) + 990;
                    targets.table.push( objectTable );
                }

                // sphere layout
                const vector = new THREE.Vector3();
                for ( let i = 0, l = objects.length; i < l; i ++ ) {
                    const phi = Math.acos( - 1 + ( 2 * i ) / l );
                    const theta = Math.sqrt( l * Math.PI ) * phi;
                    const object = new THREE.Object3D();
                    object.position.setFromSphericalCoords( 800, phi, theta );
                    vector.copy( object.position ).multiplyScalar( 2 );
                    object.lookAt( vector );
                    targets.sphere.push( object );
                }

                // helix layout
                for ( let i = 0, l = objects.length; i < l; i ++ ) {
                    const theta = (i * 0.175) + Math.PI; 
                    const y = - ( i * 8 ) + 450;
                    const offset = (i % 2 === 0) ? 0 : Math.PI; 
                    const object = new THREE.Object3D();
                    object.position.setFromCylindricalCoords( 900, theta + offset, y );
                    vector.x = object.position.x * 2;
                    vector.y = object.position.y;
                    vector.z = object.position.z * 2;
                    object.lookAt( vector );
                    targets.helix.push( object );
                }

                // grid layout eh
                for ( let i = 0; i < objects.length; i ++ ) {
                    const object = new THREE.Object3D();
                    object.position.x = ( ( i % 5 ) * 400 ) - 800;
                    object.position.y = ( - ( Math.floor( i / 5 ) % 4 ) * 400 ) + 800;
                    object.position.z = ( Math.floor( i / 20 ) ) * 1000 - 2000;
                    targets.grid.push( object );
                }

                // renderer
                renderer = new CSS3DRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.getElementById( 'container' ).appendChild( renderer.domElement );

                // controls
                controls = new TrackballControls( camera, renderer.domElement );
                controls.minDistance = 500;
                controls.maxDistance = 6000;
                controls.addEventListener( 'change', render );

                // button function
                const buttonTable = document.getElementById( 'table' );
                buttonTable.addEventListener( 'click', function () { transform( targets.table, 2000 ); } );

                const buttonSphere = document.getElementById( 'sphere' );
                buttonSphere.addEventListener( 'click', function () { transform( targets.sphere, 2000 ); } );

                const buttonHelix = document.getElementById( 'helix' );
                buttonHelix.addEventListener( 'click', function () { transform( targets.helix, 2000 ); } );

                const buttonGrid = document.getElementById( 'grid' );
                buttonGrid.addEventListener( 'click', function () { transform( targets.grid, 2000 ); } );

                const buttonReset = document.getElementById( 'reset' );
                if (buttonReset) {
                    buttonReset.addEventListener( 'click', function () { 
                        transform( targets.table, 2000 ); 
                        controls.reset();
                    });
                }

                transform( targets.table, 2000 );
                window.addEventListener( 'resize', onWindowResize );
            }

            // animation
            function transform( targets, duration ) {
                TWEEN.removeAll();
                for ( let i = 0; i < objects.length; i ++ ) {
                    const object = objects[ i ];
                    const target = targets[ i ];
                    new TWEEN.Tween( object.position )
                        .to( { x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration )
                        .easing( TWEEN.Easing.Exponential.InOut )
                        .start();
                    new TWEEN.Tween( object.rotation )
                        .to( { x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration )
                        .easing( TWEEN.Easing.Exponential.InOut )
                        .start();
                }
                new TWEEN.Tween( this )
                    .to( {}, duration * 2 )
                    .onUpdate( render )
                    .start();
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );
                render();
            }

            function animate() {
                requestAnimationFrame( animate );
                TWEEN.update();
                controls.update();
            }

            function render() {
                renderer.render( scene, camera );
            }

            loadData();

        </script>
    </body>
</html>